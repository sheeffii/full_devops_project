name: 'Discord Notification'
description: 'Send rich notifications to Discord webhook'
inputs:
  webhook_url:
    description: 'Discord webhook URL'
    required: true
  status:
    description: 'Status: started, success, failure, cancelled'
    required: true
  title:
    description: 'Notification title'
    required: true
  description:
    description: 'Notification description'
    required: false
    default: ''
  fields:
    description: 'JSON array of fields [{name, value, inline}]'
    required: false
    default: '[]'

runs:
  using: 'composite'
  steps:
    - name: Send Discord notification
      shell: bash
      run: |
        # Determine color based on status
        case "${{ inputs.status }}" in
          started)
            COLOR=3447003  # Blue
            EMOJI="üöÄ"
            ;;
          success)
            COLOR=3066993  # Green
            EMOJI="‚úÖ"
            ;;
          failure)
            COLOR=15158332 # Red
            EMOJI="‚ùå"
            ;;
          cancelled)
            COLOR=10070709 # Grey
            EMOJI="‚ö†Ô∏è"
            ;;
          *)
            COLOR=0
            EMOJI="‚ÑπÔ∏è"
            ;;
        esac

        # Escape fields JSON (replace backticks with \` to prevent command substitution)
        FIELDS='${{ inputs.fields }}'
        
        # Build embed JSON using jq for proper escaping
        PAYLOAD=$(jq -n \
          --arg title "$EMOJI ${{ inputs.title }}" \
          --arg description "${{ inputs.description }}" \
          --argjson color "$COLOR" \
          --argjson fields "$FIELDS" \
          --arg footer "GitHub Actions ‚Ä¢ ${{ github.repository }}" \
          --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          '{
            "embeds": [{
              "title": $title,
              "description": $description,
              "color": $color,
              "fields": $fields,
              "footer": {"text": $footer},
              "timestamp": $timestamp
            }]
          }')

        # Send to Discord
        curl -H "Content-Type: application/json" \
             -d "$PAYLOAD" \
             "${{ inputs.webhook_url }}"
