name: Discord Bot CI/CD

on:
  workflow_dispatch:

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY: discord-bot

jobs:
  build-and-push:
    name: Build and Push Bot Image
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Notify Discord - Bot Build Started
        uses: ./.github/actions/discord-notify
        if: always()
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: started
          title: Bot Build Started
          description: "Building Discord bot Docker image..."
          fields: |
            [
              {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true},
              {"name": "Branch", "value": "`${{ github.ref_name }}`", "inline": true},
              {"name": "Actor", "value": "${{ github.actor }}", "inline": true}
            ]

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image
        working-directory: ./discord-bot
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG .
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG

      - name: Notify Discord - Bot Build Success
        uses: ./.github/actions/discord-notify
        if: success()
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: success
          title: Bot Build Successful
          description: "Discord bot image pushed to ECR"
          fields: |
            [
              {"name": "Repository", "value": "`${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}`", "inline": false}
            ]

      - name: Notify Discord - Bot Build Failure
        uses: ./.github/actions/discord-notify
        if: failure()
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: failure
          title: Bot Build Failed
          description: "Failed to build/push Discord bot image"
          fields: |
            [
              {"name": "Logs", "value": "[View Error Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
            ]

  deploy:
    name: Deploy Bot to EC2
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.13.4'

      - name: Get Infrastructure Info
        id: infra
        working-directory: ./infrastructure/dev
        run: |
          terraform init -backend=false
          echo "instance_id=$(terraform output -raw ec2_instance_id)" >> $GITHUB_OUTPUT

      - name: Notify Discord - Bot Deploy Started
        uses: ./.github/actions/discord-notify
        if: always()
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: started
          title: Bot Deployment Started
          description: "Deploying Discord bot to EC2..."
          fields: |
            [
              {"name": "Instance ID", "value": "`${{ steps.infra.outputs.instance_id }}`", "inline": true}
            ]

      - name: Deploy bot via SSM
        env:
          REPOSITORY: ${{ env.ECR_REPOSITORY }}
          REGION: ${{ env.AWS_REGION }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
          BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
          GIT_REPO: ${{ github.repository }}
        run: |
          INSTANCE_ID="${{ steps.infra.outputs.instance_id }}"
          
          # Create .env content from GitHub Secrets
          ENV_CONTENT="DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
          DISCORD_GUILD_ID=${DISCORD_GUILD_ID}
          GITHUB_TOKEN=${BOT_GITHUB_TOKEN}
          GIT_REPO=${GIT_REPO}"
          
          # Deploy bot with auto-created .env
          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy Discord bot container" \
            --parameters commands="[
              \"set -e\",
              \"ACCOUNT_ID=\\\$(aws sts get-caller-identity --query Account --output text)\",
              \"ECR=\\\"\\\$ACCOUNT_ID.dkr.ecr.${REGION}.amazonaws.com\\\"\",
              \"aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin \\\"\\\$ECR\\\"\",
              \"sudo mkdir -p /opt/discord-bot\",
              \"echo \\\"${ENV_CONTENT}\\\" | sudo tee /opt/discord-bot/.env > /dev/null\",
              \"sudo chmod 600 /opt/discord-bot/.env\",
              \"docker pull \\\"\\\$ECR/${REPOSITORY}:latest\\\"\",
              \"docker stop devops-bot 2>/dev/null || true\",
              \"docker rm devops-bot 2>/dev/null || true\",
              \"docker run -d --name devops-bot --restart unless-stopped --env-file /opt/discord-bot/.env \\\"\\\$ECR/${REPOSITORY}:latest\\\"\"
            ]" \
            --region ${{ env.AWS_REGION }} \
            --output text \
            --query "Command.CommandId"

      - name: Notify Discord - Bot Deploy Success
        uses: ./.github/actions/discord-notify
        if: success()
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: success
          title: Bot Deployment Successful
          description: "Discord bot is running on EC2 with restart policy"

      - name: Notify Discord - Bot Deploy Failure
        uses: ./.github/actions/discord-notify
        if: failure()
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: failure
          title: Bot Deployment Failed
          description: "Failed to deploy Discord bot to EC2"
          fields: |
            [
              {"name": "Instance ID", "value": "`${{ steps.infra.outputs.instance_id }}`", "inline": true},
              {"name": "Logs", "value": "[View Error Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
            ]